---
import { Icon } from "astro-icon/components";
import SectionHero from "./SectionHero.astro";
import BackgroundGrid from "./BackgroundGrid.astro";
import contactHeaderBg from "../assets/headers/contact_header_background.png";
import MapLocation from "./shareComponents/mapLocation.astro";
import { imageConfig } from "astro:assets";

const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;
---

<section id="contacto" class="bg-[#08080A] relative overflow-hidden">
  <SectionHero
    title="Cont√°ctanos"
    subtitle="Estamos listos para atender sus requerimientos de ingenier√≠a y mantenimiento."
    image={contactHeaderBg}
    large={true}
    breadcrumbItems={[
      { name: "Inicio", href: "/" },
      { name: "Contacto", href: "/contact", current: true },
    ]}
  />

  <!-- Tech Grid Background Pattern -->
  <div
    class="absolute inset-0 z-0 pointer-events-none opacity-[0.15] mt-[60vh]"
    style="background-image: radial-gradient(#31B0FF 1px, transparent 1px); background-size: 30px 30px; mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);"
  >
  </div>

  <!-- Background Elements -->
  <div class="absolute inset-0 z-0 pointer-events-none mt-[60vh]">
    <div
      class="absolute top-0 right-0 w-[600px] h-[500px] bg-[#31B0FF]/5 blur-[120px] rounded-full"
    >
    </div>
    <div
      class="absolute bottom-0 left-0 w-[500px] h-[400px] bg-[#0099cc]/5 blur-[100px] rounded-full"
    >
    </div>
  </div>

  <div
    class="relative z-10 container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl pt-20 pb-24"
  >
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-16 items-start">
      <!-- Columna Izquierda: Informaci√≥n de Contacto (5 cols) -->
      <div class="lg:col-span-5 flex flex-col gap-10 animate-item">
        <!-- Header Texto -->
        <div>
          <span
            class="text-[#31B0FF] font-semibold text-xs uppercase tracking-[0.3em] mb-3 block"
            >Atenci√≥n Directa</span
          >
          <h2
            class="text-2xl lg:text-3xl font-bold text-white mb-4 tracking-tight leading-tight"
          >
            Ponte en <span class="text-gray-400">Contacto</span>
          </h2>
          <p class="text-gray-400 leading-relaxed text-sm">
            Estamos listos para atender tus requerimientos de ingenier√≠a y
            mantenimiento predictivo.
          </p>
        </div>

        <!-- Lista de Cards -->
        <div class="flex flex-col gap-6">
          <!-- Direcci√≥n -->
          <div
            class="animate-item group relative bg-[#0d1117] rounded-xl overflow-hidden border border-white/5 hover:border-[#31B0FF]/30 transition-all duration-500 hover:shadow-[0_10px_40px_-10px_rgba(49,176,255,0.15)]"
          >
            <div class="p-5 h-full flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-lg bg-[#31B0FF]/10 flex items-center justify-center text-[#31B0FF] group-hover:bg-[#31B0FF]/20 transition-colors duration-300 shrink-0"
              >
                <Icon name="lucide:map-pin" class="w-5 h-5" />
              </div>
              <div class="flex-grow">
                <h3
                  class="text-xs font-semibold text-[#31B0FF] uppercase tracking-wider mb-1"
                >
                  Oficina Central
                </h3>
                <p class="text-gray-200 text-sm">
                  Calle Plateros 330, Cusco - Per√∫
                </p>
              </div>
            </div>
          </div>

          <!-- RUC -->
          <div
            class="animate-item group relative bg-[#0d1117] rounded-xl overflow-hidden border border-white/5 hover:border-[#31B0FF]/30 transition-all duration-500 hover:shadow-[0_10px_40px_-10px_rgba(49,176,255,0.15)]"
          >
            <div class="p-5 h-full flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-lg bg-[#31B0FF]/10 flex items-center justify-center text-[#31B0FF] group-hover:bg-[#31B0FF]/20 transition-colors duration-300 shrink-0"
              >
                <Icon name="lucide:file-text" class="w-5 h-5" />
              </div>
              <div class="flex-grow">
                <h3
                  class="text-xs font-semibold text-[#31B0FF] uppercase tracking-wider mb-1"
                >
                  RUC
                </h3>
                <p class="text-gray-200 text-sm">
                  20615340082
                </p>
              </div>
            </div>
          </div>

          <!-- Email -->
          <div
            class="animate-item group relative bg-[#0d1117] rounded-xl overflow-hidden border border-white/5 hover:border-[#31B0FF]/30 transition-all duration-500 hover:shadow-[0_10px_40px_-10px_rgba(49,176,255,0.15)]"
          >
            <div class="p-5 h-full flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-lg bg-[#31B0FF]/10 flex items-center justify-center text-[#31B0FF] group-hover:bg-[#31B0FF]/20 transition-colors duration-300 shrink-0"
              >
                <Icon name="lucide:mail" class="w-5 h-5" />
              </div>
              <div class="flex-grow">
                <h3
                  class="text-xs font-semibold text-[#31B0FF] uppercase tracking-wider mb-1"
                >
                  Consultas Generales
                </h3>
                <a
                  href="mailto:info@mbcpredictive.com, yonatanpaccoylla@gmail.com, percypy30@gmail.com, alvarezh.alexanderfranklin@gmail.com"
                  class="text-gray-200 text-sm hover:text-[#31B0FF] transition-colors"
                  >info@mbcpredictive.com</a
                >
              </div>
            </div>
          </div>

          <!-- Tel√©fono -->
          <div
            class="animate-item group relative bg-[#0d1117] rounded-xl overflow-hidden border border-white/5 hover:border-[#31B0FF]/30 transition-all duration-500 hover:shadow-[0_10px_40px_-10px_rgba(49,176,255,0.15)]"
          >
            <div class="p-5 h-full flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-lg bg-[#31B0FF]/10 flex items-center justify-center text-[#31B0FF] group-hover:bg-[#31B0FF]/20 transition-colors duration-300 shrink-0"
              >
                <Icon name="lucide:phone" class="w-5 h-5" />
              </div>
              <div class="flex-grow">
                <h3
                  class="text-xs font-semibold text-[#31B0FF] uppercase tracking-wider mb-1"
                >
                  Atenci√≥n Inmediata
                </h3>
                <a
                  href="tel:+51965131553"
                  class="text-gray-200 text-sm hover:text-[#31B0FF] transition-colors"
                  >(+51) 965 131 553</a
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Redes Sociales -->
        <div class="pt-4">
          <h3
            class="text-gray-500 text-[10px] font-bold uppercase tracking-[0.3em] mb-6"
          >
            Presencia Digital
          </h3>
          <div class="flex gap-4">
            <a
              href="#"
              class="w-12 h-12 rounded-xl bg-[#11161d] border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-[#31B0FF] hover:border-[#31B0FF] transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-[#31B0FF]/20 group"
            >
              <Icon
                name="lucide:facebook"
                class="w-5 h-5 group-hover:scale-110 transition-transform"
              />
            </a>
            <a
              href="#"
              class="w-12 h-12 rounded-xl bg-[#11161d] border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-[#31B0FF] hover:border-[#31B0FF] transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-[#31B0FF]/20 group"
            >
              <Icon
                name="lucide:instagram"
                class="w-5 h-5 group-hover:scale-110 transition-transform"
              />
            </a>
            <a
              href="https://www.linkedin.com/company/mbc-confiabilidad/"
              target="_blank"
              rel="noopener noreferrer"
              class="w-12 h-12 rounded-xl bg-[#11161d] border border-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-[#31B0FF] hover:border-[#31B0FF] transition-all hover:-translate-y-1 hover:shadow-lg hover:shadow-[#31B0FF]/20 group"
            >
              <Icon
                name="lucide:linkedin"
                class="w-5 h-5 group-hover:scale-110 transition-transform"
              />
            </a>
          </div>
        </div>
      </div>

      <!-- Columna Derecha: Formulario (7 cols) -->
      <div class="lg:col-span-7">
        <div
          class="animate-item group relative bg-[#0d1117] rounded-xl overflow-hidden border border-white/5 hover:border-[#31B0FF]/20 transition-all duration-500 hover:shadow-[0_10px_40px_-10px_rgba(49,176,255,0.1)]"
        >
          <div class="p-6 lg:p-8 h-full">
            <div class="mb-6">
              <div class="flex items-center gap-2 mb-3">
                <div class="h-px w-6 bg-[#31B0FF]"></div>
                <span
                  class="text-xs font-semibold text-[#31B0FF] uppercase tracking-[0.3em]"
                  >Gesti√≥n de Solicitudes</span
                >
              </div>
              <h3 class="text-2xl font-bold text-white mb-2 tracking-tight">
                Env√≠anos un Mensaje
              </h3>
              <p class="text-gray-400 text-sm">
                Nuestro personal t√©cnico evaluar√° su requerimiento en menos de
                24 horas laborables.
              </p>
            </div>

            <form
              id="contact-form"
              class="space-y-5 relative z-10"
              method="post"
              action="#"
              data-recaptcha-enabled={RECAPTCHA_SITE_KEY ? "true" : "false"}
              novalidate
            >
              <!-- Campo Nombres -->
              <div class="group relative">
                <input
                  type="text"
                  name="nombre"
                  id="nombre"
                  class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-5 pt-6 pb-2 rounded-xl text-white text-base focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all h-14"
                  placeholder=" "
                  required
                />
                <label
                  for="nombre"
                  class="absolute left-5 top-2 text-gray-400 text-xs font-medium uppercase tracking-wider transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-4 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-2 peer-focus:text-[#31B0FF] peer-focus:text-xs peer-focus:uppercase peer-focus:tracking-wider pointer-events-none"
                >
                  Nombres y Apellidos
                </label>
                <span
                  class="error-msg hidden text-red-400 text-xs mt-1 ml-2 flex items-center gap-1"
                  ><Icon name="lucide:alert-circle" class="w-3 h-3" /> El nombre es
                  requerido</span
                >
              </div>

              <!-- Campo Empresa -->
              <div class="group relative">
                <input
                  type="text"
                  name="empresa"
                  id="empresa"
                  class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-5 pt-6 pb-2 rounded-xl text-white text-base focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all h-14"
                  placeholder=" "
                />
                <label
                  for="empresa"
                  class="absolute left-5 top-2 text-gray-400 text-xs font-medium uppercase tracking-wider transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-4 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-2 peer-focus:text-[#31B0FF] peer-focus:text-xs peer-focus:uppercase peer-focus:tracking-wider pointer-events-none"
                >
                  Empresa (Opcional)
                </label>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <!-- Campo Email -->
                <div class="group relative">
                  <input
                    type="email"
                    name="email"
                    id="email"
                    class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-5 pt-6 pb-2 rounded-xl text-white text-base focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all h-14"
                    placeholder=" "
                    required
                  />
                  <label
                    for="email"
                    class="absolute left-5 top-2 text-gray-500 text-xs font-bold uppercase tracking-[0.2em] transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-4 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-2 peer-focus:text-[#31B0FF] peer-focus:text-xs peer-focus:uppercase peer-focus:tracking-[0.2em] pointer-events-none"
                  >
                    Correo Corporativo
                  </label>
                  <span
                    class="error-msg hidden text-red-400 text-xs mt-1 ml-2 flex items-center gap-1"
                    ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Email inv√°lido</span
                  >
                </div>

                <!-- Campo Tel√©fono -->
                <div class="group relative">
                  <input
                    type="tel"
                    name="telefono"
                    id="telefono"
                    class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-5 pt-6 pb-2 rounded-xl text-white text-base focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all h-14"
                    placeholder=" "
                    required
                  />
                  <label
                    for="telefono"
                    class="absolute left-5 top-2 text-gray-500 text-xs font-bold uppercase tracking-[0.2em] transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-4 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-2 peer-focus:text-[#31B0FF] peer-focus:text-xs peer-focus:uppercase peer-focus:tracking-[0.2em] pointer-events-none"
                  >
                    Tel√©fono / WhatsApp
                  </label>
                  <span
                    class="error-msg hidden text-red-400 text-xs mt-1 ml-2 flex items-center gap-1"
                    ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Requerido</span
                  >
                </div>
              </div>

              <!-- Campo Mensaje -->
              <div class="group relative">
                <textarea
                  name="mensaje"
                  id="mensaje"
                  rows="4"
                  class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-5 pt-6 pb-2 rounded-xl text-white text-base focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all resize-none shadow-inner"
                  placeholder=" "
                  required></textarea>
                <label
                  for="mensaje"
                  class="absolute left-5 top-2 text-gray-500 text-xs font-bold uppercase tracking-[0.2em] transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-4 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-2 peer-focus:text-[#31B0FF] peer-focus:text-xs peer-focus:uppercase peer-focus:tracking-[0.2em] pointer-events-none"
                >
                  Mensaje o Requerimiento T√©cnico
                </label>
                <span
                  class="error-msg hidden text-red-400 text-xs mt-1 ml-2 flex items-center gap-1"
                  ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Escribe tu
                  mensaje</span
                >
              </div>

              <!-- Captcha error message (shown above) -->
              <div
                id="captcha-error"
                class="hidden text-amber-400 text-xs font-medium flex items-center gap-2 mb-2"
              >
                <Icon name="lucide:shield-alert" class="w-4 h-4" />
                <span>Por favor, completa la verificaci√≥n de seguridad.</span>
              </div>

              <!-- Google reCAPTCHA -->
              <div
                class="flex justify-start transform origin-left scale-[0.85] md:scale-90 g-recaptcha-container hidden transition-all duration-300 min-h-[78px]"
              >
                {RECAPTCHA_SITE_KEY ? (
                  <div
                    class="g-recaptcha"
                    data-sitekey={RECAPTCHA_SITE_KEY}
                    data-theme="dark"
                    data-callback="onRecaptchaSuccess"
                  >
                  </div>
                ) : (
                  <div class="text-red-400 text-xs border border-red-500/50 bg-red-500/10 p-2 rounded">Falta configurar SITE_KEY en .env</div>
                )}
              </div>

              <!-- Bot√≥n de Env√≠o -->
              <div class="pt-4">
                <button
                  type="submit"
                  class="w-full h-14 bg-[#31B0FF] hover:bg-[#2196F3] text-white font-bold rounded-xl shadow-lg hover:shadow-[#31B0FF]/30 transition-all duration-500 flex justify-center items-center gap-3 overflow-hidden group/submit relative"
                >
                  <div
                    class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover/submit:translate-x-[100%] transition-transform duration-1000"
                  >
                  </div>
                  <span class="tracking-[0.3em] text-xs uppercase relative z-10"
                    >Enviar Requerimiento</span
                  >
                  <Icon
                    name="lucide:send"
                    class="w-5 h-5 relative z-10 group-hover/submit:translate-x-1 group-hover/submit:-translate-y-1 transition-transform"
                  />
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Mapa Integrado -->
    <div
      class="w-full max-w-7xl mx-auto h-96 rounded-2xl overflow-hidden shadow-2xl border border-white/10 relative group bg-[#0d1216] mt-6 px-4 sm:px-0 mb-16"
    >
      <div
        class="absolute inset-1 border-2 border-[#31B0FF]/0 group-hover:border-[#31B0FF]/30 transition-colors z-20 pointer-events-none rounded-2xl"
      >
      </div>
      <MapLocation />
    </div>

    <!-- Notification Toast -->
    <div
      id="notification-toast"
      class="fixed top-24 right-4 z-[100] translate-x-full opacity-0 transition-all duration-500 ease-in-out pointer-events-none"
    >
      <div
        class="bg-[#0d1216] border-l-4 border-[#31B0FF] rounded-lg shadow-[0_0_20px_rgba(0,0,0,0.5)] p-4 pr-10 flex items-center gap-4 min-w-[300px]"
      >
        <div
          class="w-10 h-10 rounded-full bg-[#31B0FF]/20 flex items-center justify-center text-[#31B0FF] shrink-0"
        >
          <Icon name="lucide:check-circle" class="w-6 h-6" />
        </div>
        <div>
          <h4 class="text-white font-bold text-sm">¬°Mensaje Enviado!</h4>
          <p class="text-gray-400 text-xs mt-1">
            Nos pondremos en contacto pronto.
          </p>
        </div>
      </div>
    </div>

    <!-- Scripts L√≥gica de Validaci√≥n -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script is:inline>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("contact-form");
        const errorMsg = document.getElementById("captcha-error");
        const toast = document.getElementById("notification-toast");

        // Funci√≥n para mostrar Toast
        const showToast = () => {
          if (!toast) return;
          toast.classList.remove("translate-x-full", "opacity-0");
          setTimeout(() => {
            toast.classList.add("translate-x-full", "opacity-0");
          }, 5000); // 5 segundos
        };

        // Recaptcha Callback (Global)
        window.onRecaptchaSuccess = () => {
          const customEvent = new Event("recaptcha-verified");
          // Asegurarse de que el formulario exista en el scope si es inline
          const form = document.getElementById("contact-form");
          if (form) form.dispatchEvent(customEvent);
        };

        // Validaci√≥n de campos simple
        const validateField = (input) => {
          const group = input.closest(".group");
          const errorSpan = group.querySelector(".error-msg");
          let isValid = true;

          if (input.hasAttribute("required") && !input.value.trim()) {
            isValid = false;
          }
          if (input.type === "email" && input.value) {
            // Regex corregido
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(input.value)) isValid = false;
          }

          if (!isValid) {
            input.classList.add(
              "border-red-500",
              "focus:border-red-500",
              "focus:ring-red-500",
            );
            input.classList.remove(
              "border-gray-700/50",
              "focus:border-[#31B0FF]",
              "focus:ring-[#31B0FF]",
            );
            if (errorSpan) errorSpan.classList.remove("hidden");
          } else {
            input.classList.remove(
              "border-red-500",
              "focus:border-red-500",
              "focus:ring-red-500",
            );
            input.classList.add(
              "border-gray-700/50",
              "focus:border-[#31B0FF]",
              "focus:ring-[#31B0FF]",
            );
            if (errorSpan) errorSpan.classList.add("hidden");
          }
          return isValid;
        };

        // Listeners para validaci√≥n en tiempo real (al salir del campo)
        const inputs = form?.querySelectorAll("input, textarea");
        inputs?.forEach((input) => {
          input.addEventListener("blur", () => validateField(input));
          input.addEventListener("input", () => {
            // Limpiar error al escribir
            const group = input.closest(".group");
            const errorSpan = group.querySelector(".error-msg");
            if (input.classList.contains("border-red-500")) {
              input.classList.remove(
                "border-red-500",
                "focus:border-red-500",
                "focus:ring-red-500",
              );
              input.classList.add(
                "border-gray-700/50",
                "focus:border-[#31B0FF]",
                "focus:ring-[#31B0FF]",
              );
              if (errorSpan) errorSpan.classList.add("hidden");
            }
          });
        });

        if (form) {
          const recaptchaContainer = form.querySelector(
            ".g-recaptcha-container",
          );
          const submitBtn = form.querySelector('button[type="submit"]');
          const captchaError = document.getElementById("captcha-error");
          const isRecaptchaEnabled = form.dataset.recaptchaEnabled === "true";

          // Manejar el submit inicial (clic en Enviar)
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            let isFormValid = true;

            // Validar todos los campos
            inputs?.forEach((input) => {
              if (!validateField(input)) isFormValid = false;
            });

            if (!isFormValid) return;

            // Verificar si ya tenemos token
            // @ts-ignore
            let recaptchaToken = "";
            
            if (isRecaptchaEnabled) {
              try {
                if (typeof grecaptcha !== 'undefined') {
                  recaptchaToken = grecaptcha.getResponse();
                }
              } catch (e) {
                console.warn("reCAPTCHA no inicializado o bloqueado");
              }

              if (!recaptchaToken) {
                // Si es v√°lido pero no hay token, mostrar el captcha
                if (recaptchaContainer) {
                  recaptchaContainer.classList.remove("hidden");
                  recaptchaContainer.classList.add("animate-fade-in");
                }
                if (submitBtn) submitBtn.classList.add("hidden");
                if (captchaError) captchaError.classList.remove("hidden");
                captchaError.innerText =
                  "Por favor, completa la verificaci√≥n abajo üëá";
                return;
              }
            }

            // Si llegamos aqu√≠, tenemos token y formulario v√°lido -> ENVIAR
            await submitForm(recaptchaToken);
          });

          // Evento personalizado disparado por el callback de recaptcha
          form.addEventListener("recaptcha-verified", async () => {
            // @ts-ignore
            const token = grecaptcha.getResponse();
            if (token) {
              await submitForm(token);
            }
          });

          async function submitForm(token) {
            const originalBtnText = submitBtn ? submitBtn.innerHTML : "";
            if (submitBtn) {
              submitBtn.classList.remove("hidden");
              submitBtn.disabled = true;
              submitBtn.innerHTML = `<span class="animate-spin mr-2">‚ü≥</span> Enviando...`;
            }
            if (recaptchaContainer) recaptchaContainer.classList.add("hidden");
            if (captchaError) captchaError.classList.add("hidden");

            // Preparar datos
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.recaptcha = token;

            try {
              const response = await fetch("/api/contact", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
              });

              if (response.ok) {
                showToast();
                form.reset();
                // @ts-ignore
                grecaptcha.reset();
                if (recaptchaContainer)
                  recaptchaContainer.classList.add("hidden");
              } else {
                // @ts-ignore
                grecaptcha.reset();
                if (recaptchaContainer)
                  recaptchaContainer.classList.remove("hidden");
                const result = await response.json();
                alert(
                  "Error: " +
                    (result.message || "No se pudo enviar el mensaje"),
                );
              }
            } catch (error) {
              console.error(error);
              alert("Error de conexi√≥n");
              // @ts-ignore
              grecaptcha.reset();
              if (recaptchaContainer)
                recaptchaContainer.classList.remove("hidden");
            } finally {
              if (submitBtn) {
                submitBtn.disabled = false;
                // Restaurar SVG y texto (Simplificado)
                submitBtn.innerHTML = `<span>ENVIAR MENSAJE</span> <svg data-icon="lucide:send" class="w-4 h-4" viewBox="0 0 24 24" fill="none" class="w-4 h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg>`;
              }
            }
          }
        }

        // Animation Observer
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
              }
            });
          },
          { threshold: 0.1 },
        );
        document
          .querySelectorAll(".animate-item")
          .forEach((el) => observer.observe(el));
      });
    </script>

    <style>
      .animate-item {
        opacity: 0;
        transform: translateY(1rem);
        transition: all 0.7s ease-out;
      }
      .animate-item.is-visible {
        opacity: 1;
        transform: translateY(0);
      }
      .animate-spin {
        display: inline-block;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Holographic Border Effect */
      @keyframes border-rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .holo-border::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(
          transparent,
          transparent,
          transparent,
          #31b0ff,
          transparent,
          transparent,
          transparent,
          #22d3ee
        );
        animation: border-rotate 4s linear infinite;
      }
    </style>
  </div>
</section>
