---
import { Icon } from "astro-icon/components";

import MapLocation from "./shareComponents/mapLocation.astro";
---

<section
  class="relative min-h-screen flex flex-col justify-center bg-[#08080A] py-20 overflow-hidden"
  id="contacto"
>
  <!-- Background Solid Color -->
  <div class="absolute inset-0 z-0 bg-[#08080A]"></div>

  <!-- Fondo Sutil -->
  <div class="absolute inset-0 z-0 pointer-events-none">
    <div
      class="absolute top-0 right-0 w-[600px] h-[400px] bg-[#31B0FF]/5 blur-[100px] rounded-full"
    >
    </div>
    <div
      class="absolute bottom-0 left-0 w-[400px] h-[300px] bg-[#31B0FF]/3 blur-[80px] rounded-full"
    >
    </div>
  </div>

  <div
    class="relative z-10 container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl pt-10"
  >
    <!-- Section Title (Centrado) -->
    <div class="flex flex-col items-center mb-16 animate-item bg-white/1 py-6">
      <h2
        class="text-xl lg:text-2xl font-semibold text-white tracking-tight leading-tight mb-4"
      >
        Cont√°ctanos
      </h2>
      <div
        class="h-1 w-20 bg-gradient-to-r from-[#31B0FF] to-[#0099cc] rounded-full"
      >
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-start">
      <!-- Columna Izquierda: Informaci√≥n de Contacto -->
      <div class="flex flex-col h-full animate-item">
        <div class="mb-8">
          <p
            class="text-base text-gray-400 leading-relaxed border-l-2 border-[#31B0FF]/30 pl-4 max-w-lg"
          >
            Ponemos a tu disposici√≥n nuestros datos de contacto para que puedas
            comunicarte con nosotros de manera r√°pida y sencilla.
          </p>
        </div>

        <!-- Lista de Contacto -->
        <div class="space-y-6 flex-grow">
          <!-- Direcci√≥n -->
          <div class="flex items-start gap-4 group">
            <div
              class="flex-shrink-0 w-12 h-12 rounded-lg bg-gray-900/80 flex items-center justify-center text-[#31B0FF] border border-white/5 group-hover:border-[#31B0FF]/50 group-hover:shadow-[0_0_15px_rgba(49,176,255,0.15)] transition-all duration-300"
            >
              <Icon name="lucide:map-pin" class="w-6 h-6" />
            </div>
            <div>
              <p
                class="text-xs text-[#31B0FF] font-bold uppercase tracking-widest mb-1"
              >
                Oficina Central
              </p>
              <p class="text-gray-200 text-base font-light">
                Calle Plateros 330, Cusco - Per√∫
              </p>
            </div>
          </div>

          <!-- Email -->
          <div class="flex items-start gap-4 group">
            <div
              class="flex-shrink-0 w-12 h-12 rounded-lg bg-gray-900/80 flex items-center justify-center text-[#31B0FF] border border-white/5 group-hover:border-[#31B0FF]/50 group-hover:shadow-[0_0_15px_rgba(49,176,255,0.15)] transition-all duration-300"
            >
              <Icon name="lucide:mail" class="w-6 h-6" />
            </div>
            <div>
              <p
                class="text-xs text-[#31B0FF] font-bold uppercase tracking-widest mb-1"
              >
                Consultas Generales
              </p>
              <a
                href="mailto:gerencia@mbc.pe"
                class="text-gray-200 text-base font-light hover:text-[#31B0FF] transition-colors"
              >
                info@mbcpredictive.com
              </a>
            </div>
          </div>

          <!-- Tel√©fono -->
          <div class="flex items-start gap-4 group">
            <div
              class="flex-shrink-0 w-12 h-12 rounded-lg bg-gray-900/80 flex items-center justify-center text-[#31B0FF] border border-white/5 group-hover:border-[#31B0FF]/50 group-hover:shadow-[0_0_15px_rgba(49,176,255,0.15)] transition-all duration-300"
            >
              <Icon name="lucide:phone" class="w-6 h-6" />
            </div>
            <div>
              <p
                class="text-xs text-[#31B0FF] font-bold uppercase tracking-widest mb-1"
              >
                Tel√©fonos
              </p>
              <a
                href="tel:+51000000000"
                class="text-gray-200 text-base font-light hover:text-[#31B0FF] transition-colors block"
              >
                (+51) 000 000 000 / (+51) 000 000 000
              </a>
            </div>
          </div>
        </div>

        <!-- Redes y Mapa -->
        <div class="mt-8 space-y-6">
          <div>
            <h3
              class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-3"
            >
              Mantenerse en contacto
            </h3>
            <div class="flex gap-3">
              <a
                href="#"
                class="w-9 h-9 rounded-md bg-white/5 border border-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-[#31B0FF] hover:border-[#31B0FF] transition-all hover:-translate-y-0.5"
              >
                <Icon name="lucide:facebook" class="w-4 h-4" />
              </a>
              <a
                href="#"
                class="w-9 h-9 rounded-md bg-white/5 border border-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-[#31B0FF] hover:border-[#31B0FF] transition-all hover:-translate-y-0.5"
              >
                <Icon name="lucide:instagram" class="w-4 h-4" />
              </a>
              <a
                href="#"
                class="w-9 h-9 rounded-md bg-white/5 border border-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-[#31B0FF] hover:border-[#31B0FF] transition-all hover:-translate-y-0.5"
              >
                <Icon name="lucide:linkedin" class="w-4 h-4" />
              </a>
            </div>
          </div>

          <!-- Mapa Integrado -->
          <div
            class="w-full h-32 rounded-lg overflow-hidden shadow-2xl border border-white/10 relative group"
          >
            <MapLocation />
          </div>
        </div>
      </div>

      <!-- Columna Derecha: Formulario -->
      <div
        class="bg-[#0d1216]/80 backdrop-blur-xl border border-white/10 rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.6)] p-6 lg:p-8 relative overflow-hidden animate-item"
      >
        <!-- Decoraci√≥n fondo -->
        <div
          class="absolute top-0 right-0 w-48 h-48 bg-[#31B0FF]/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"
        >
        </div>

        <h3 class="text-2xl font-bold text-white mb-2 relative z-10">
          ¬øTienes Preguntas?
        </h3>
        <p class="text-gray-400 text-sm mb-6 relative z-10">
          D√©janos un mensaje y pronto nos pondremos en contacto contigo.
        </p>

        <form
          id="contact-form"
          class="space-y-4 relative z-10"
          method="post"
          action="#"
          novalidate
        >
          <!-- Campo Nombres -->
          <div class="group relative">
            <input
              type="text"
              name="nombre"
              id="nombre"
              class="peer w-full bg-[#151922] border border-gray-700/50 px-4 pt-5 pb-1 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all"
              placeholder=" "
              required
            />
            <label
              for="nombre"
              class="absolute left-4 top-1.5 text-gray-400 text-xs transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3 peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-xs pointer-events-none"
            >
              Nombres y Apellidos
            </label>
            <span class="error-msg hidden text-red-400 text-xs mt-1 ml-1"
              >‚ö† El nombre es requerido</span
            >
          </div>

          <!-- Campo Empresa (Opcional) -->
          <div class="group relative">
            <input
              type="text"
              name="empresa"
              id="empresa"
              class="peer w-full bg-[#151922] border border-gray-700/50 px-4 pt-5 pb-1 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all"
              placeholder=" "
            />
            <label
              for="empresa"
              class="absolute left-4 top-1.5 text-gray-400 text-xs transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3 peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-xs pointer-events-none"
            >
              Empresa (Opcional)
            </label>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Campo Email -->
            <div class="group relative">
              <input
                type="email"
                name="email"
                id="email"
                class="peer w-full bg-[#151922] border border-gray-700/50 px-4 pt-5 pb-1 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all"
                placeholder=" "
                required
              />
              <label
                for="email"
                class="absolute left-4 top-1.5 text-gray-400 text-xs transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3 peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-xs pointer-events-none"
              >
                Correo Electr√≥nico
              </label>
              <span class="error-msg hidden text-red-400 text-xs mt-1 ml-1"
                >‚ö† Email inv√°lido</span
              >
            </div>

            <!-- Campo Tel√©fono -->
            <div class="group relative">
              <input
                type="tel"
                name="telefono"
                id="telefono"
                class="peer w-full bg-[#151922] border border-gray-700/50 px-4 pt-5 pb-1 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all"
                placeholder=" "
                required
              />
              <label
                for="telefono"
                class="absolute left-4 top-1.5 text-gray-400 text-xs transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3 peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-xs pointer-events-none"
              >
                Tel√©fono
              </label>
              <span class="error-msg hidden text-red-400 text-xs mt-1 ml-1"
                >‚ö† Tel√©fono requerido</span
              >
            </div>
          </div>

          <!-- Campo Mensaje -->
          <div class="group relative">
            <textarea
              name="mensaje"
              id="mensaje"
              rows="3"
              class="peer w-full bg-[#151922] border border-gray-700/50 px-4 pt-5 pb-1 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all resize-none"
              placeholder=" "
              required></textarea>
            <label
              for="mensaje"
              class="absolute left-4 top-1.5 text-gray-400 text-xs transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3 peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-xs pointer-events-none"
            >
              Mensaje
            </label>
            <span class="error-msg hidden text-red-400 text-xs mt-1 ml-1"
              >‚ö† Escribe tu mensaje</span
            >
          </div>

          <!-- Google reCAPTCHA (Oculto inicialmente) -->
          <div
            class="flex justify-start transform origin-left scale-[0.85] md:scale-90 g-recaptcha-container hidden transition-all duration-300"
          >
            <div
              class="g-recaptcha"
              data-sitekey={import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY}
              data-theme="dark"
              data-callback="onRecaptchaSuccess"
            >
            </div>
          </div>
          <div
            id="captcha-error"
            class="hidden text-red-400 text-xs font-bold flex items-center gap-2 -mt-2"
          >
            <Icon name="lucide:alert-circle" class="w-4 h-4" />
            <span>Por favor, verifica que no eres un robot.</span>
          </div>

          <!-- Bot√≥n de Env√≠o -->
          <div class="pt-2">
            <button
              type="submit"
              class="w-full bg-gradient-to-r from-[#31B0FF] to-[#0099cc] hover:from-[#2995d9] hover:to-[#0080aa] text-white font-bold py-3 px-8 rounded-lg shadow-[0_0_15px_rgba(49,176,255,0.3)] hover:shadow-[0_0_25px_rgba(49,176,255,0.5)] transition-all duration-300 transform hover:-translate-y-0.5 flex justify-center items-center gap-2"
            >
              <span>ENVIAR MENSAJE</span>
              <Icon name="lucide:send" class="w-4 h-4" />
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div
    id="notification-toast"
    class="fixed top-24 right-4 z-[100] translate-x-full opacity-0 transition-all duration-500 ease-in-out pointer-events-none"
  >
    <div
      class="bg-[#0d1216] border-l-4 border-[#31B0FF] rounded-lg shadow-[0_0_20px_rgba(0,0,0,0.5)] p-4 pr-10 flex items-center gap-4 min-w-[300px]"
    >
      <div
        class="w-10 h-10 rounded-full bg-[#31B0FF]/20 flex items-center justify-center text-[#31B0FF] shrink-0"
      >
        <Icon name="lucide:check-circle" class="w-6 h-6" />
      </div>
      <div>
        <h4 class="text-white font-bold text-sm">¬°Mensaje Enviado!</h4>
        <p class="text-gray-400 text-xs mt-1">
          Nos pondremos en contacto pronto.
        </p>
      </div>
    </div>
  </div>

  <!-- Scripts L√≥gica de Validaci√≥n -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("contact-form");
      const errorMsg = document.getElementById("captcha-error");
      const toast = document.getElementById("notification-toast");

      // Funci√≥n para mostrar Toast
      const showToast = () => {
        if (!toast) return;
        toast.classList.remove("translate-x-full", "opacity-0");
        setTimeout(() => {
          toast.classList.add("translate-x-full", "opacity-0");
        }, 5000); // 5 segundos
      };

      // Recaptcha Callback (Global)
      window.onRecaptchaSuccess = () => {
        const customEvent = new Event("recaptcha-verified");
        // Asegurarse de que el formulario exista en el scope si es inline
        const form = document.getElementById("contact-form");
        if (form) form.dispatchEvent(customEvent);
      };

      // Validaci√≥n de campos simple
      const validateField = (input) => {
        const group = input.closest(".group");
        const errorSpan = group.querySelector(".error-msg");
        let isValid = true;

        if (input.hasAttribute("required") && !input.value.trim()) {
          isValid = false;
        }
        if (input.type === "email" && input.value) {
          // Regex corregido
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(input.value)) isValid = false;
        }

        if (!isValid) {
          input.classList.add(
            "border-red-500",
            "focus:border-red-500",
            "focus:ring-red-500",
          );
          input.classList.remove(
            "border-gray-700/50",
            "focus:border-[#31B0FF]",
            "focus:ring-[#31B0FF]",
          );
          if (errorSpan) errorSpan.classList.remove("hidden");
        } else {
          input.classList.remove(
            "border-red-500",
            "focus:border-red-500",
            "focus:ring-red-500",
          );
          input.classList.add(
            "border-gray-700/50",
            "focus:border-[#31B0FF]",
            "focus:ring-[#31B0FF]",
          );
          if (errorSpan) errorSpan.classList.add("hidden");
        }
        return isValid;
      };

      // Listeners para validaci√≥n en tiempo real (al salir del campo)
      const inputs = form?.querySelectorAll("input, textarea");
      inputs?.forEach((input) => {
        input.addEventListener("blur", () => validateField(input));
        input.addEventListener("input", () => {
          // Limpiar error al escribir
          const group = input.closest(".group");
          const errorSpan = group.querySelector(".error-msg");
          if (input.classList.contains("border-red-500")) {
            input.classList.remove(
              "border-red-500",
              "focus:border-red-500",
              "focus:ring-red-500",
            );
            input.classList.add(
              "border-gray-700/50",
              "focus:border-[#31B0FF]",
              "focus:ring-[#31B0FF]",
            );
            if (errorSpan) errorSpan.classList.add("hidden");
          }
        });
      });

      if (form) {
        const recaptchaContainer = form.querySelector(".g-recaptcha-container");
        const submitBtn = form.querySelector('button[type="submit"]');
        const captchaError = document.getElementById("captcha-error");

        // Manejar el submit inicial (clic en Enviar)
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          let isFormValid = true;

          // Validar todos los campos
          inputs?.forEach((input) => {
            if (!validateField(input)) isFormValid = false;
          });

          if (!isFormValid) return;

          // Verificar si ya tenemos token
          // @ts-ignore
          const recaptchaToken = grecaptcha.getResponse();

          if (!recaptchaToken) {
            // Si es v√°lido pero no hay token, mostrar el captcha
            if (recaptchaContainer) {
              recaptchaContainer.classList.remove("hidden");
              recaptchaContainer.classList.add("animate-fade-in");
            }
            if (submitBtn) submitBtn.classList.add("hidden");
            if (captchaError) captchaError.classList.remove("hidden");
            captchaError.innerText =
              "Por favor, completa la verificaci√≥n abajo üëá";
            return;
          }

          // Si llegamos aqu√≠, tenemos token y formulario v√°lido -> ENVIAR
          await submitForm(recaptchaToken);
        });

        // Evento personalizado disparado por el callback de recaptcha
        form.addEventListener("recaptcha-verified", async () => {
          // @ts-ignore
          const token = grecaptcha.getResponse();
          if (token) {
            await submitForm(token);
          }
        });

        async function submitForm(token) {
          const originalBtnText = submitBtn ? submitBtn.innerHTML : "";
          if (submitBtn) {
            submitBtn.classList.remove("hidden");
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="animate-spin mr-2">‚ü≥</span> Enviando...`;
          }
          if (recaptchaContainer) recaptchaContainer.classList.add("hidden");
          if (captchaError) captchaError.classList.add("hidden");

          // Preparar datos
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          data.recaptcha = token;

          try {
            const response = await fetch("/api/contact", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              showToast();
              form.reset();
              // @ts-ignore
              grecaptcha.reset();
              if (recaptchaContainer)
                recaptchaContainer.classList.add("hidden");
            } else {
              // @ts-ignore
              grecaptcha.reset();
              if (recaptchaContainer)
                recaptchaContainer.classList.remove("hidden");
              const result = await response.json();
              alert(
                "Error: " + (result.message || "No se pudo enviar el mensaje"),
              );
            }
          } catch (error) {
            console.error(error);
            alert("Error de conexi√≥n");
            // @ts-ignore
            grecaptcha.reset();
            if (recaptchaContainer)
              recaptchaContainer.classList.remove("hidden");
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              // Restaurar SVG y texto (Simplificado)
              submitBtn.innerHTML = `<span>ENVIAR MENSAJE</span> <svg data-icon="lucide:send" class="w-4 h-4" viewBox="0 0 24 24" fill="none" class="w-4 h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg>`;
            }
          }
        }
      }

      // Animation Observer
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
            }
          });
        },
        { threshold: 0.1 },
      );
      document
        .querySelectorAll(".animate-item")
        .forEach((el) => observer.observe(el));
    });
  </script>

  <style>
    /* Estilos Adicionales si son necesarios */
    .animate-item {
      opacity: 0;
      transform: translateY(1rem);
      transition: all 0.7s ease-out;
    }
    .animate-item.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    .animate-spin {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</section>
