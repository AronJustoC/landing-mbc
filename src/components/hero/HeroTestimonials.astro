---
import { Icon } from "astro-icon/components";
import testimonyRoberto from "../../assets/hero/testimony-roberto.png";
import testimonyMaria from "../../assets/hero/testimony-maria.png";
import testimonyCarlos from "../../assets/hero/testimony-carlos.png";
---

<section class="reveal-section bg-[#08080A] py-32 relative">
    <div class="container mx-auto px-6">
        <div class="mb-16 text-center animate-item">
            <h2 class="text-3xl md:text-5xl font-bold text-white mb-4">
                Lo que dicen nuestros clientes
            </h2>
            <p class="text-gray-400 text-lg">
                Resultados comprobados por líderes de la industria
            </p>
        </div>

        <div class="animate-item relative max-w-5xl mx-auto">
            <!-- Slider Container with Premium Look -->
            <div
                class="overflow-hidden rounded-3xl bg-[#121214] border border-white/5 relative z-10 shadow-2xl"
            >
                <div
                    class="testimonial-track flex transition-transform duration-700 cubic-bezier(0.2, 0.8, 0.2, 1)"
                >
                    {
                        [
                            {
                                text: "Análisis riguroso y recomendaciones claras que mejoraron nuestra confiabilidad operativa en molinos críticos. Un socio estratégico real.",
                                author: "Ing. Roberto Sanchez",
                                role: "Gerente de Mantenimiento",
                                company: "Compañía Minera Antamina",
                                img: testimonyRoberto,
                            },
                            {
                                text: "Excelente interpretación de vibraciones y comportamiento estructural. Solucionaron un problema crónico que afectaba la producción mensual.",
                                author: "Ing. Maria Campos",
                                role: "Superintendente de Planta",
                                company: "Sociedad Minera Cerro Verde",
                                img: testimonyMaria,
                            },
                            {
                                text: "Enfoque técnico sólido y acompañamiento continuo durante todo el despliegue del sistema de monitoreo en tiempo real. Altamente recomendados.",
                                author: "Ing. Carlos Mendoza",
                                role: "Jefe de Confiabilidad",
                                company: "Minera Antapacay",
                                img: testimonyCarlos,
                            },
                        ].map((t) => (
                            <div class="testimonial-slide w-full flex-shrink-0 p-8 md:p-16 flex flex-col md:flex-row items-center gap-10 md:gap-16">
                                <div class="relative shrink-0 group">
                                    <div class="w-32 h-32 md:w-40 md:h-40 rounded-2xl p-1 bg-gradient-to-br from-cyan-500 to-blue-600 shadow-[0_0_30px_rgba(6,182,212,0.3)]">
                                        <img
                                            src={t.img.src}
                                            alt={`Foto de ${t.author}`}
                                            class="w-full h-full rounded-xl object-cover border-2 border-[#121214] filter contrast-110"
                                            loading="lazy"
                                            decoding="async"
                                        />
                                    </div>
                                    <div class="absolute -bottom-4 -right-4 bg-[#08080A] rounded-xl p-3 border border-gray-800 shadow-lg group-hover:scale-110 transition-transform duration-300">
                                        <Icon
                                            name="lucide:quote"
                                            class="w-6 h-6 text-cyan-400"
                                        />
                                    </div>
                                </div>

                                <div class="text-center md:text-left flex-1">
                                    <div class="mb-6">
                                        {Array(5)
                                            .fill(0)
                                            .map((_, i) => (
                                                <Icon
                                                    name="lucide:star"
                                                    class="inline-block w-5 h-5 text-yellow-500 fill-yellow-500 mr-1"
                                                />
                                            ))}
                                    </div>
                                    <p class="text-xl md:text-2xl text-gray-200 font-light italic mb-8 leading-relaxed">
                                        "{t.text}"
                                    </p>
                                    <div>
                                        <h4 class="text-white font-bold text-xl mb-1">
                                            {t.author}
                                        </h4>
                                        <p class="text-cyan-400 font-medium mb-1">
                                            {t.role}
                                        </p>
                                        <p class="text-gray-500 text-sm uppercase tracking-wider">
                                            {t.company}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>

            <!-- Navigation Buttons - Floating outside -->
            <button
                class="test-prev absolute top-1/2 -left-5 md:-left-20 -translate-y-1/2 w-12 h-12 md:w-14 md:h-14 rounded-full bg-[#121214] border border-gray-800 text-white hover:border-cyan-500 hover:text-cyan-400 transition-all z-20 flex items-center justify-center hover:shadow-[0_0_20px_rgba(6,182,212,0.2)]"
            >
                <Icon name="lucide:arrow-left" class="w-6 h-6" />
            </button>
            <button
                class="test-next absolute top-1/2 -right-5 md:-right-20 -translate-y-1/2 w-12 h-12 md:w-14 md:h-14 rounded-full bg-[#121214] border border-gray-800 text-white hover:border-cyan-500 hover:text-cyan-400 transition-all z-20 flex items-center justify-center hover:shadow-[0_0_20px_rgba(6,182,212,0.2)]"
            >
                <Icon name="lucide:arrow-right" class="w-6 h-6" />
            </button>

            <!-- Dots Indicators -->
            <div class="flex justify-center gap-3 mt-10">
                {
                    [0, 1, 2].map((i) => (
                        <button
                            class="test-dot w-3 h-3 rounded-full bg-gray-800 hover:bg-cyan-500 transition-all duration-300"
                            data-index={i}
                            aria-label={`Ir a testimonio ${i + 1}`}
                        />
                    ))
                }
            </div>
        </div>
    </div>
</section>

<script>
    function initTestimonialSlider() {
        const track = document.querySelector(".testimonial-track");
        const slides = document.querySelectorAll(".testimonial-slide");
        const nextBtn = document.querySelector(".test-next");
        const prevBtn = document.querySelector(".test-prev");
        const dots = document.querySelectorAll(".test-dot");

        // Fix: check if track is null or empty before existing
        if (!track) return;
        if (slides.length === 0) return;

        let currentIndex = 0;

        const updateSlide = (index: number) => {
            currentIndex = index;
            if (track instanceof HTMLElement)
                track.style.transform = `translateX(-${currentIndex * 100}%)`;

            dots.forEach((dot, i) => {
                if (i === currentIndex) {
                    dot.classList.add("bg-cyan-400");
                    dot.classList.remove("bg-gray-800");
                } else {
                    dot.classList.remove("bg-cyan-400");
                    dot.classList.add("bg-gray-800");
                }
            });
        };

        nextBtn?.addEventListener("click", () => {
            const nextIndex = (currentIndex + 1) % slides.length;
            updateSlide(nextIndex);
        });

        prevBtn?.addEventListener("click", () => {
            const prevIndex =
                (currentIndex - 1 + slides.length) % slides.length;
            updateSlide(prevIndex);
        });

        dots.forEach((dot, i) => {
            dot.addEventListener("click", () => updateSlide(i));
        });

        // Init
        updateSlide(0);
    }

    document.addEventListener("DOMContentLoaded", initTestimonialSlider);
    document.addEventListener("astro:page-load", initTestimonialSlider);
</script>
