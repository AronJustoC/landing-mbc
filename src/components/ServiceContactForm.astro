---
import { Icon } from "astro-icon/components";

interface Props {
    serviceName: string;
}

const { serviceName } = Astro.props;
---

<div
    class="bg-[#11161d] p-8 rounded-2xl border border-white/10 relative overflow-hidden group"
>
    <!-- Glow effect -->
    <div
        class="absolute -top-20 -right-20 w-40 h-40 bg-[#31B0FF]/10 rounded-full blur-[50px] group-hover:bg-[#31B0FF]/20 transition-all duration-500"
    >
    </div>

    <h3 class="text-xl font-bold text-white mb-2 relative z-10">
        Solicitar Información
    </h3>
    <p class="text-gray-400 text-sm mb-6 relative z-10">
        ¿Interesado en <span class="text-[#31B0FF] font-medium"
            >{serviceName}</span
        >? Déjanos tus datos.
    </p>

    <form
        id="service-contact-form"
        class="space-y-4 relative z-10"
        method="post"
        novalidate
    >
        <input type="hidden" name="service" value={serviceName} />

        <!-- Nombre -->
        <div class="group relative">
            <input
                type="text"
                name="nombre"
                id="service-nombre"
                class="peer w-full bg-[#08080A] border border-gray-700/50 px-4 pt-5 pb-2 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all h-12 shadow-inner"
                placeholder=" "
                required
            />
            <label
                for="service-nombre"
                class="absolute left-4 top-1.5 text-gray-400 text-[10px] font-medium uppercase tracking-wider transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[10px] peer-focus:uppercase peer-focus:tracking-wider pointer-events-none"
            >
                Nombre Completo
            </label>
            <span
                class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Requerido</span
            >
        </div>

        <!-- Email -->
        <div class="group relative">
            <input
                type="email"
                name="email"
                id="service-email"
                class="peer w-full bg-[#08080A] border border-gray-700/50 px-4 pt-5 pb-2 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all h-12 shadow-inner"
                placeholder=" "
                required
            />
            <label
                for="service-email"
                class="absolute left-4 top-1.5 text-gray-400 text-[10px] font-medium uppercase tracking-wider transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[10px] peer-focus:uppercase peer-focus:tracking-wider pointer-events-none"
            >
                Correo Corporativo
            </label>
            <span
                class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Email inválido</span
            >
        </div>

        <!-- Teléfono -->
        <div class="group relative">
            <input
                type="tel"
                name="telefono"
                id="service-telefono"
                class="peer w-full bg-[#08080A] border border-gray-700/50 px-4 pt-5 pb-2 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all h-12 shadow-inner"
                placeholder=" "
                required
            />
            <label
                for="service-telefono"
                class="absolute left-4 top-1.5 text-gray-400 text-[10px] font-medium uppercase tracking-wider transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[10px] peer-focus:uppercase peer-focus:tracking-wider pointer-events-none"
            >
                Teléfono / WhatsApp
            </label>
            <span
                class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Requerido</span
            >
        </div>

        <!-- Mensaje -->
        <div class="group relative">
            <textarea
                name="mensaje"
                id="service-mensaje"
                rows="3"
                class="peer w-full bg-[#08080A] border border-gray-700/50 px-4 pt-5 pb-2 rounded-lg text-white text-sm focus:outline-none focus:border-[#31B0FF] focus:ring-1 focus:ring-[#31B0FF] placeholder:text-transparent transition-all resize-none shadow-inner"
                placeholder=" "
                required
                >Hola, me gustaría cotizar el servicio de {
                    serviceName
                }...</textarea
            >
            <label
                for="service-mensaje"
                class="absolute left-4 top-1.5 text-gray-400 text-[10px] font-medium uppercase tracking-wider transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[10px] peer-focus:uppercase peer-focus:tracking-wider pointer-events-none"
            >
                Mensaje o Solicitud
            </label>
            <span
                class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Escribe tu mensaje</span
            >
        </div>

        <!-- Google reCAPTCHA -->
        <div
            class="flex justify-start transform origin-left scale-[0.85] g-recaptcha-container hidden transition-all duration-300 min-h-[78px]"
        >
            <div
                class="g-recaptcha"
                data-sitekey={import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY}
                data-theme="dark"
                data-callback="onServiceRecaptchaSuccess"
            >
            </div>
        </div>
        <div
            id="service-captcha-error"
            class="hidden text-red-400 text-[10px] font-bold flex items-center gap-2 -mt-2 ml-1"
        >
            <Icon name="lucide:alert-circle" class="w-3 h-3" />
            <span>Verifica que no eres un robot.</span>
        </div>

        <button
            type="submit"
            id="service-submit-btn"
            class="w-full bg-[#31B0FF] hover:bg-[#2094df] text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-[#31B0FF]/25 transition-all duration-300 transform hover:-translate-y-0.5 flex justify-center items-center gap-2"
        >
            <span>Solicitar Propuesta</span>
            <Icon name="lucide:arrow-right" class="w-4 h-4" />
        </button>

        <p
            id="service-feedback"
            class="text-xs text-center min-h-[1.5em] font-medium"
        >
        </p>
    </form>
</div>

<!-- Load reCAPTCHA API -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script is:inline>
    // Logic for service contact form
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("service-contact-form");
        const feedback = document.getElementById("service-feedback");
        const recaptchaContainer = form?.querySelector(
            ".g-recaptcha-container",
        );
        const captchaError = document.getElementById("service-captcha-error");
        const submitBtn = document.getElementById("service-submit-btn");

        if (!form) return;

        // Custom function for Toast if available globally or simple alert
        const notify = (msg, success = true) => {
            if (feedback) {
                feedback.innerHTML = `<span class="${success ? "text-green-400" : "text-red-400"}">${msg}</span>`;
            }
        };

        // Recaptcha Callback (Global)
        window.onServiceRecaptchaSuccess = () => {
            const customEvent = new Event("service-recaptcha-verified");
            form.dispatchEvent(customEvent);
        };

        // Validation logic
        const validateField = (input) => {
            const group = input.closest(".group");
            const errorSpan = group?.querySelector(".error-msg");
            let isValid = true;

            if (input.hasAttribute("required") && !input.value.trim()) {
                isValid = false;
            }
            if (input.type === "email" && input.value) {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(input.value)) isValid = false;
            }

            if (!isValid) {
                input.classList.add("border-red-500");
                if (errorSpan) errorSpan.classList.remove("hidden");
            } else {
                input.classList.remove("border-red-500");
                if (errorSpan) errorSpan.classList.add("hidden");
            }
            return isValid;
        };

        const inputs = form.querySelectorAll("input, textarea");
        inputs.forEach((input) => {
            input.addEventListener("blur", () => validateField(input));
            input.addEventListener("input", () => {
                if (input.classList.contains("border-red-500")) {
                    validateField(input);
                }
            });
        });

        const submitForm = async (token) => {
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="animate-spin mr-2">⟳</span> Enviando...`;

            if (recaptchaContainer) recaptchaContainer.classList.add("hidden");
            if (captchaError) captchaError.classList.add("hidden");
            if (submitBtn) submitBtn.classList.remove("hidden");

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.recaptcha = token;

            // Format mensaje to include service name explicitly if needed by backend or just for clarity
            // data.mensaje = `[SERVICIO: ${data.service}] ${data.mensaje}`;

            try {
                const response = await fetch("/api/contact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    notify("¡Solicitud enviada con éxito!", true);
                    form.reset();
                    // @ts-ignore
                    grecaptcha.reset();
                    if (recaptchaContainer)
                        recaptchaContainer.classList.add("hidden");
                } else {
                    const result = await response.json();
                    notify(
                        result.message || "Error al enviar. Intente de nuevo.",
                        false,
                    );
                    // @ts-ignore
                    grecaptcha.reset();
                    if (recaptchaContainer)
                        recaptchaContainer.classList.remove("hidden");
                }
            } catch (err) {
                notify("Error de conexión. Verifique su internet.", false);
                // @ts-ignore
                grecaptcha.reset();
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
            }
        };

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            let isFormValid = true;

            inputs.forEach((input) => {
                if (!validateField(input)) isFormValid = false;
            });

            if (!isFormValid) return;

            // @ts-ignore
            const recaptchaToken = grecaptcha.getResponse();

            if (!recaptchaToken) {
                if (recaptchaContainer) {
                    recaptchaContainer.classList.remove("hidden");
                    recaptchaContainer.classList.add("animate-fade-in");
                }
                if (submitBtn) submitBtn.classList.add("hidden");
                if (captchaError) captchaError.classList.remove("hidden");
                return;
            }

            await submitForm(recaptchaToken);
        });

        form.addEventListener("service-recaptcha-verified", async () => {
            // @ts-ignore
            const token = grecaptcha.getResponse();
            if (token) {
                await submitForm(token);
            }
        });
    });
</script>

<style>
    .animate-spin {
        display: inline-block;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
