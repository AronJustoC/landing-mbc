---
import { Icon } from "astro-icon/components";

interface Props {
    serviceName: string;
}

const { serviceName } = Astro.props;
---

<div
    class="animate-item group holo-card relative bg-[#121214] rounded-2xl overflow-hidden transition-all duration-500 hover:shadow-[0_0_50px_rgba(49,176,255,0.1)]"
>
    <div
        class="holo-border absolute inset-0 rounded-2xl z-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
    >
    </div>
    <div
        class="relative z-10 bg-[#121214] p-8 lg:p-10 h-full rounded-2xl border border-white/5 group-hover:border-transparent transition-colors"
    >
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-4">
                <div class="h-px w-8 bg-[#31B0FF]"></div>
                <span
                    class="text-[9px] font-bold text-[#31B0FF] uppercase tracking-[0.3em]"
                    >Consulta Técnica</span
                >
            </div>
            <h3 class="text-xl font-bold text-white mb-2 tracking-tight">
                Solicitar Información
            </h3>
            <p class="text-gray-400 text-sm font-light leading-relaxed">
                ¿Interesado en <span class="text-[#31B0FF] font-medium"
                    >{serviceName}</span
                >? Nuestro equipo de ingenieros le enviará una propuesta
                técnica.
            </p>
        </div>

        <form
            id="service-contact-form"
            class="space-y-4 relative z-10"
            method="post"
            novalidate
        >
            <input type="hidden" name="service" value={serviceName} />

            <!-- Nombre -->
            <div class="group relative">
                <input
                    type="text"
                    name="nombre"
                    id="service-nombre"
                    class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-4 pt-5 pb-2 rounded-xl text-white text-sm focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all h-12"
                    placeholder=" "
                    required
                />
                <label
                    for="service-nombre"
                    class="absolute left-4 top-1.5 text-gray-500 text-[9px] font-bold uppercase tracking-[0.2em] transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[9px] peer-focus:uppercase peer-focus:tracking-[0.2em] pointer-events-none"
                >
                    Nombre Completo
                </label>
                <span
                    class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                    ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Requerido</span
                >
            </div>

            <!-- Email -->
            <div class="group relative">
                <input
                    type="email"
                    name="email"
                    id="service-email"
                    class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-4 pt-5 pb-2 rounded-xl text-white text-sm focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all h-12"
                    placeholder=" "
                    required
                />
                <label
                    for="service-email"
                    class="absolute left-4 top-1.5 text-gray-500 text-[9px] font-bold uppercase tracking-[0.2em] transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[9px] peer-focus:uppercase peer-focus:tracking-[0.2em] pointer-events-none"
                >
                    Correo Corporativo
                </label>
                <span
                    class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                    ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Email inválido</span
                >
            </div>

            <!-- Teléfono -->
            <div class="group relative">
                <input
                    type="tel"
                    name="telefono"
                    id="service-telefono"
                    class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-4 pt-5 pb-2 rounded-xl text-white text-sm focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all h-12"
                    placeholder=" "
                    required
                />
                <label
                    for="service-telefono"
                    class="absolute left-4 top-1.5 text-gray-500 text-[9px] font-bold uppercase tracking-[0.2em] transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[9px] peer-focus:uppercase peer-focus:tracking-[0.2em] pointer-events-none"
                >
                    Teléfono / WhatsApp
                </label>
                <span
                    class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                    ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Requerido</span
                >
            </div>

            <!-- Mensaje -->
            <div class="group relative">
                <textarea
                    name="mensaje"
                    id="service-mensaje"
                    rows="3"
                    class="peer w-full bg-[#1a1f26]/50 border border-white/5 px-4 pt-5 pb-2 rounded-xl text-white text-sm focus:outline-none focus:border-[#31B0FF]/50 focus:bg-[#31B0FF]/5 transition-all resize-none shadow-inner"
                    placeholder=" "
                    required
                    >Hola, me gustaría cotizar el servicio de {
                        serviceName
                    }...</textarea
                >
                <label
                    for="service-mensaje"
                    class="absolute left-4 top-1.5 text-gray-500 text-[9px] font-bold uppercase tracking-[0.2em] transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-3.5 peer-placeholder-shown:normal-case peer-placeholder-shown:tracking-normal peer-focus:top-1.5 peer-focus:text-[#31B0FF] peer-focus:text-[9px] peer-focus:uppercase peer-focus:tracking-[0.2em] pointer-events-none"
                >
                    Mensaje o Solicitud Técnica
                </label>
                <span
                    class="error-msg hidden text-red-400 text-[10px] mt-1 ml-1 flex items-center gap-1"
                    ><Icon name="lucide:alert-circle" class="w-3 h-3" /> Escribe tu
                    mensaje</span
                >
            </div>

            <!-- Google reCAPTCHA -->
            <div
                class="flex justify-start transform origin-left scale-[0.85] g-recaptcha-container hidden transition-all duration-300 min-h-[78px]"
            >
                <div
                    class="g-recaptcha"
                    data-sitekey={import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY}
                    data-theme="dark"
                    data-callback="onServiceRecaptchaSuccess"
                >
                </div>
            </div>
            <div
                id="service-captcha-error"
                class="hidden text-red-400 text-[10px] font-bold flex items-center gap-2 -mt-2 ml-1"
            >
                <Icon name="lucide:alert-circle" class="w-3 h-3" />
                <span>Verifica que no eres un robot.</span>
            </div>

            <!-- Botón de Envío -->
            <div class="pt-2">
                <button
                    type="submit"
                    id="service-submit-btn"
                    class="w-full h-12 bg-[#31B0FF] hover:bg-[#2196F3] text-white font-bold rounded-xl shadow-lg hover:shadow-[#31B0FF]/30 transition-all duration-500 flex justify-center items-center gap-2 overflow-hidden group/submit relative"
                >
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover/submit:translate-x-[100%] transition-transform duration-1000"
                    >
                    </div>
                    <span
                        class="tracking-[0.2em] text-[10px] uppercase relative z-10"
                        >Solicitar Propuesta</span
                    >
                    <Icon
                        name="lucide:arrow-right"
                        class="w-4 h-4 relative z-10 group-hover/submit:translate-x-1 transition-transform"
                    />
                </button>
            </div>

            <p
                id="service-feedback"
                class="text-xs text-center min-h-[1.5em] font-medium"
            >
            </p>
        </form>
    </div>

    <!-- Load reCAPTCHA API -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <script is:inline>
        // Logic for service contact form
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("service-contact-form");
            const feedback = document.getElementById("service-feedback");
            const recaptchaContainer = form?.querySelector(
                ".g-recaptcha-container",
            );
            const captchaError = document.getElementById(
                "service-captcha-error",
            );
            const submitBtn = document.getElementById("service-submit-btn");

            if (!form) return;

            // Custom function for Toast if available globally or simple alert
            const notify = (msg, success = true) => {
                if (feedback) {
                    feedback.innerHTML = `<span class="${success ? "text-green-400" : "text-red-400"}">${msg}</span>`;
                }
            };

            // Recaptcha Callback (Global)
            window.onServiceRecaptchaSuccess = () => {
                const customEvent = new Event("service-recaptcha-verified");
                form.dispatchEvent(customEvent);
            };

            // Validation logic
            const validateField = (input) => {
                const group = input.closest(".group");
                const errorSpan = group?.querySelector(".error-msg");
                let isValid = true;

                if (input.hasAttribute("required") && !input.value.trim()) {
                    isValid = false;
                }
                if (input.type === "email" && input.value) {
                    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailPattern.test(input.value)) isValid = false;
                }

                if (!isValid) {
                    input.classList.add("border-red-500");
                    if (errorSpan) errorSpan.classList.remove("hidden");
                } else {
                    input.classList.remove("border-red-500");
                    if (errorSpan) errorSpan.classList.add("hidden");
                }
                return isValid;
            };

            const inputs = form.querySelectorAll("input, textarea");
            inputs.forEach((input) => {
                input.addEventListener("blur", () => validateField(input));
                input.addEventListener("input", () => {
                    if (input.classList.contains("border-red-500")) {
                        validateField(input);
                    }
                });
            });

            const submitForm = async (token) => {
                const originalBtnContent = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<span class="animate-spin mr-2">⟳</span> Enviando...`;

                if (recaptchaContainer)
                    recaptchaContainer.classList.add("hidden");
                if (captchaError) captchaError.classList.add("hidden");
                if (submitBtn) submitBtn.classList.remove("hidden");

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.recaptcha = token;

                // Format mensaje to include service name explicitly if needed by backend or just for clarity
                // data.mensaje = `[SERVICIO: ${data.service}] ${data.mensaje}`;

                try {
                    const response = await fetch("/api/contact", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        notify("¡Solicitud enviada con éxito!", true);
                        form.reset();
                        // @ts-ignore
                        grecaptcha.reset();
                        if (recaptchaContainer)
                            recaptchaContainer.classList.add("hidden");
                    } else {
                        const result = await response.json();
                        notify(
                            result.message ||
                                "Error al enviar. Intente de nuevo.",
                            false,
                        );
                        // @ts-ignore
                        grecaptcha.reset();
                        if (recaptchaContainer)
                            recaptchaContainer.classList.remove("hidden");
                    }
                } catch (err) {
                    notify("Error de conexión. Verifique su internet.", false);
                    // @ts-ignore
                    grecaptcha.reset();
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnContent;
                }
            };

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                let isFormValid = true;

                inputs.forEach((input) => {
                    if (!validateField(input)) isFormValid = false;
                });

                if (!isFormValid) return;

                // @ts-ignore
                const recaptchaToken = grecaptcha.getResponse();

                if (!recaptchaToken) {
                    if (recaptchaContainer) {
                        recaptchaContainer.classList.remove("hidden");
                        recaptchaContainer.classList.add("animate-fade-in");
                    }
                    if (submitBtn) submitBtn.classList.add("hidden");
                    if (captchaError) captchaError.classList.remove("hidden");
                    return;
                }

                await submitForm(recaptchaToken);
            });

            form.addEventListener("service-recaptcha-verified", async () => {
                // @ts-ignore
                const token = grecaptcha.getResponse();
                if (token) {
                    await submitForm(token);
                }
            });
        });
    </script>

    <style>
        .animate-spin {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Holographic Border Effect */
        @keyframes border-rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .holo-border::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent,
                transparent,
                transparent,
                #31b0ff,
                transparent,
                transparent,
                transparent,
                #22d3ee
            );
            animation: border-rotate 4s linear infinite;
        }
    </style>
</div>
